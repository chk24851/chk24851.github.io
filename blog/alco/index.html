<!DOCTYPE html>
<html lang="ja">
<head>
  <title>黄昏酒場</title>
  <style>
    body { display: none; }
  </style>
  <link rel="stylesheet" href="../../style.css">
  <script src="../../loader.js"></script>
</head>
<body>
  <div class="container" id="container">
  </div>

  <script>
    function getYouTubeEmbedUrl(videoId, startTime = 0) {
      return `https://www.youtube.com/embed/${videoId}?start=${startTime}&autoplay=1`;
    }

    async function initializeAlco() {
      const data = {
  "stageLabels": ["Stage1", "Stage2", "Stage3"],
  "default": {
    "label": "黄昏酒場",
    "description": "基本的に，遠くの敵にはショットで，近くの敵には爪楊枝で攻撃します。道中では，敵の出現位置にあらかじめ爪楊枝を設置しておくと速攻できます。体力の多い敵には特に有効です。道中はチャプターごとに区切られています。チャプター内の敵が全滅すると直ちに次のチャプターが始まります。そのため，パターンが崩れたときはあえて敵を生かしておくことが有効になるかもしれません。ボス戦では，ボスに近づくとペナルティ弾を撃ってきます。",
    "videoId": "wHojqQ3oQYs",
    "timestamps": {
      "1": [
      ],
      "2": [
        {
          "time": 159,
          "label": "道中１",
          "content": "3-wayの自機狙い弾と自機外し弾の組み合わせです。塊ごと大きく避けましょう。"
        },
        {
          "time": 163,
          "label": "道中２",
          "content": "後方からのピザを爪楊枝で速攻しましょう。１回目は右下，２回目は左下から出現します。"
        },
        {
          "time": 188,
          "label": "道中３",
          "content": "3-wayの自機狙い弾と自機外し弾の組み合わせです。塊ごと大きく避けましょう。"
        },
        {
          "time": 197,
          "label": "ボス通常１",
          "content": "突進前後は爪楊枝を直当てして攻撃しましょう。"
        },
        {
          "time": 243,
          "label": "キリン塩味",
          "content": "<strong class='red'>難所です。</strong>全方位弾よりも高校からのランダム弾に集中しましょう。"
        }
      ],
      "3": [
        {
          "time": 297,
          "label": "道中１",
          "content": "安地があります。中央最下段か左右下端のいずれかにいれば当たりません。ただし，敵が全滅すると直ちに次のチャプターの敵が左下から湧き始めるので注意しましょう。"
        },
        {
          "time": 301,
          "label": "道中２",
          "content": "安地があります。１波目は右上端，２波目は左上端です。ただし，２波目は１波目との間隔を開けずに飛んでくるので，両方の安地を使うことはできません。結局，１波目の安地を使う場合は２波目の攻撃を右上端から左側に避け，２波目の安地を使う場合は１波目の攻撃を左上端から右側に避ける必要があります。"
        },
        {
          "time": 326,
          "label": "道中３",
          "content": "安地です。中央やや下側にいれば当たりません。"
        },
        {
          "time": 338,
          "label": "道中４",
          "content": "敵は左側から出現するので，前のチャプターの敵を左に移動しながら倒すと速攻できます。"
        },
        {
          "time": 394,
          "label": "ボス通常２",
          "content": "ミラーボールを爪楊枝で速攻しつつ，敵を追いかけながら爪楊枝を直当てして攻撃しましょう。"
        },
        {
          "time": 442,
          "label": "ボス通常３",
          "content": "レーザーが上端と左右端で反射するので，中央最下段で避けましょう。特に，上からのレーザーは交わったり狭い隙間を作ったりすることがあるので注意しましょう。"
        },
        {
          "time": 457,
          "label": "ブリリアント〆サバ",
          "content": "<strong>準難所です。</strong>画面が揺れる中，大量の長いレーザーが放たれます。レーザーが画面端で反射するので，中央最下段やや上で避けましょう。特に，上からのレーザーは交わったり狭い隙間を作ったりすることがあるので注意しましょう。"
        },
        {
          "time": 489,
          "label": "ボス通常４",
          "content": "撃ち返しか自爆するときに自機狙い弾を放ちます。自機狙いは放たれてから最下段に届くまで時間がかかる大弾なので，左右下端からチョン避けしましょう。"
        },
        {
          "time": 524,
          "label": "スピリタスの大銀河",
          "content": "青弾は下側に，赤弾は上側に動きます。上側に動きたいときは，青弾の隙間に入って赤弾の移動とともに上へ動きます。下側に移動したいときは，赤弾の隙間に入って青弾の移動とともに下へ動きます。上側から下側へ移動を切り替えたいときは，青弾の隙間を抜けた直後に直下の赤弾の隙間へ入ります。下側から上側へ移動を切り替えたいときは，赤弾の隙間を抜けた直後に直上の青弾の隙間へ入ります。どちらかの移動を固定すると避けやすいです。慣れれば難しい弾幕ではありません。"
        },
        {
          "time": 548,
          "label": "呑んべぇのレムリア",
          "content": "<strong class='red'>難所です。</strong>米粒弾の塊の弾速がバラバラで壁になりやすいです。基本は中央で避けますが，弾の配置によっては左右に移動する必要があります。無理して中央に戻ろうとせずに安全な場所で避けましょう。"
        }
      ]
    }
  }
};
      const pageConfig = data['default'];

      if (!pageConfig) return;

      const originalLabel = pageConfig.label;
      pageConfig.originalTitle = originalLabel;
      pageConfig.stageLabels = data.stageLabels;
      
      const stageData = pageConfig.timestamps || {};
      const videoFrame = document.getElementById('videoFrame');
      const videoId = pageConfig.videoId;
      const stageLabels = pageConfig.stageLabels || [];
      let currentStage = 1;

      const h1 = document.querySelector('h1');
      if (h1) h1.textContent = pageConfig.label;

      const defaultH3 = document.querySelector('#content-default h3');
      if (defaultH3) defaultH3.textContent = pageConfig.originalTitle || pageConfig.label;

      const characterMsg = document.querySelector('#content-default #character-message');
      if (characterMsg) characterMsg.textContent = pageConfig.description || '';

      const instructionMsg = document.querySelector('#content-default #instruction-message');
      if (instructionMsg) instructionMsg.textContent = '※タイムスタンプを選択すると説明が表示されます。';

      const dropdown = document.getElementById('stage-dropdown');
      if (dropdown) {
        stageLabels.forEach(function (label, index) {
          const option = document.createElement('option');
          option.value = index + 1;
          option.textContent = label;
          dropdown.appendChild(option);
        });

        dropdown.addEventListener('change', function (e) {
          currentStage = parseInt(e.target.value);
          renderTimestamps(currentStage);
          showDefaultContent();
        });
      }

      const prevBtn = document.getElementById('prev-stage');
      const nextBtn = document.getElementById('next-stage');

      if (prevBtn) {
        prevBtn.addEventListener('click', function () {
          currentStage = Math.max(1, currentStage - 1);
          if (dropdown) dropdown.value = currentStage;
          renderTimestamps(currentStage);
          showDefaultContent();
        });
      }

      if (nextBtn) {
        nextBtn.addEventListener('click', function () {
          const maxStage = Object.keys(stageData).length;
          currentStage = Math.min(maxStage, currentStage + 1);
          if (dropdown) dropdown.value = currentStage;
          renderTimestamps(currentStage);
          showDefaultContent();
        });
      }

      function renderTimestamps(stage) {
        const timestamps = stageData[stage] ? stageData[stage] : [];
        const listContainer = document.querySelector('#timestamps-list ul');
        const contentPanel = document.getElementById('content-panel');
        if (!listContainer) return;

        listContainer.innerHTML = '';

        if (timestamps.length === 0) {
          const li = document.createElement('li');
          li.textContent = '（タイムスタンプなし）';
          li.style.textAlign = 'center';
          li.style.opacity = '0.5';
          listContainer.appendChild(li);
          return;
        }

        timestamps.forEach(function (ts, index) {
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = '#';
          a.className = 'timestamp-link';
          a.textContent = ts.label;

          a.addEventListener('click', function (e) {
            e.preventDefault();
            jumpToTimestamp(stage, index);
          });

          li.appendChild(a);
          listContainer.appendChild(li);

          const contentId = `content-${stage}-${index}`;
          if (!document.getElementById(contentId)) {
            const contentDiv = document.createElement('div');
            contentDiv.id = contentId;
            contentDiv.className = 'stamp-content hidden';
            contentDiv.innerHTML = `<h3>${ts.label}</h3><p>${ts.content || ''}</p>`;
            contentPanel.appendChild(contentDiv);
          }
        });
      }

      function jumpToTimestamp(stage, index) {
        const ts = stageData[stage] ? stageData[stage][index] : null;
        if (!ts) return;

        if (videoId && videoFrame) {
          videoFrame.src = getYouTubeEmbedUrl(videoId, ts.time);
        }

        document.querySelectorAll('.stamp-content').forEach(el => {
          el.classList.add('hidden');
        });

        const contentId = `content-${stage}-${index}`;
        const selectedContent = document.getElementById(contentId);
        if (selectedContent) {
          selectedContent.classList.remove('hidden');
        }
      }

      function showDefaultContent() {
        document.querySelectorAll('.stamp-content').forEach(el => {
          el.classList.add('hidden');
        });
        const defaultContent = document.getElementById('content-default');
        if (defaultContent) defaultContent.classList.remove('hidden');
      }

      renderTimestamps(1);
      if (videoId && videoFrame) {
        videoFrame.src = getYouTubeEmbedUrl(videoId);
      }
      showDefaultContent();

      const SYNC_DELAY = 100;
      const syncPanelHeights = () => {
        const videoPanel = document.querySelector('.video-panel');
        const timestampsPanel = document.querySelector('.timestamps-panel');
        videoPanel && timestampsPanel && (timestampsPanel.style.height = videoPanel.getBoundingClientRect().height + 'px');
      };

      if (window.lastSyncPanelHeights) {
        ['load', 'resize'].forEach(event => window.removeEventListener(event, window.lastSyncPanelHeights));
      }
      window.lastSyncPanelHeights = syncPanelHeights;
      ['load', 'resize'].forEach(event => window.addEventListener(event, syncPanelHeights));
      setTimeout(syncPanelHeights, SYNC_DELAY);
    }

    const container = document.getElementById('container');
    container.innerHTML = `
      <h1></h1>
      <div class="video-container">
        <div class="video-panel">
          <div class="video-wrapper">
            <iframe id="videoFrame" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
          </div>
        </div>
        <div class="timestamps-panel">
          <div class="stage-selector">
            <button class="stage-arrow" id="prev-stage">←</button>
            <select id="stage-dropdown"></select>
            <button class="stage-arrow" id="next-stage">→</button>
          </div>
          <div class="timestamps-list" id="timestamps-list">
            <ul></ul>
          </div>
        </div>
      </div>
      <div id="content-panel" class="content-panel">
        <div id="content-default" class="stamp-content">
          <h3></h3>
          <p id="character-message"></p>
          <p id="instruction-message"></p>
        </div>
      </div>
    `;

    const allElementsReady = Promise.all([
      document.readyState === 'complete' ? Promise.resolve() : new Promise(resolve => window.addEventListener('load', resolve)),
      new Promise(resolve => {
        if (document.getElementById('videoFrame')) resolve();
        else {
          const observer = new MutationObserver(() => {
            if (document.getElementById('videoFrame')) {
              observer.disconnect();
              resolve();
            }
          });
          observer.observe(container, { childList: true, subtree: true });
        }
      })
    ]).finally(initializeAlco);
  </script>
</body>
</html>