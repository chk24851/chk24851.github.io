<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>トルテルマジック</title>
  <style>
    body { display: none; }
  </style>
  <link rel="stylesheet" href="../../style.css">
  <script src="../../loader.js"></script>
</head>
<body>
  <div class="container" id="container">
  </div>

  <script>
    function getYouTubeEmbedUrl(videoId, startTime = 0) {
      return `https://www.youtube.com/embed/${videoId}?start=${startTime}&autoplay=1`;
    }

    async function initializeTmgc() {
      const data = {
  "default": {
    "label": "トルテルマジック",
    "description": "自機の当たり判定は「スカートの裾」が目安です。道中の敵に当たり判定はありません。",
    "videoId": "mtLp4bveBmQ",
    "timestamps": [
      {
        "time": 2,
        "label": "道中１",
        "description": "敵の配置は一見するとランダムですが，ゲーム起動後１回目は同じになります。そのため，開幕の動きを固定してパターン化することができます。"
      },
      {
        "time": 89,
        "label": "道中２",
        "description": "敵がランダムに動き回りながら全方位弾を放ってきます。弾を放つタイミングもランダムで，連続で放ってくることもあります。特に厄介なのは，敵が左右の画面外の見えない場所を経由して突然左右下端に出現する可能性があることです。中央下を陣取っていてもかなり接近してくることがあるので，十分に注意する必要があります。"
      },
      {
        "time": 120,
        "label": "シュー１",
        "description": "<strong>準難所です。</strong>シューの動きによっては粒弾の列が乱れ，早めに抜ける必要がある配置になることがあります。常に弾へ近づいておき，いつでも抜けられるようにすると良いでしょう。また，<strong>ボスが出現した瞬間から攻撃が通ります。</strong>あらかじめしっかりと撃ち込んでおきましょう。"
      },
      {
        "time": 222,
        "label": "シュー２",
        "description": "<strong>準難所です。</strong>特に，赤色の加速する小弾は弾源の位置によっては難しい配置になります。また，攻撃の種類が変化する間がありません。どんな種類に変わっても対処できるように常に構えておきましょう。"
      },
      {
        "time": 251,
        "label": "シュー３",
        "description": "<strong class='red'>難所です。</strong>弾源の位置が敵の移動に合わせて相対的に変化するだけでなく，１つ前の攻撃と比べて難しい弾幕を飛ばしてきます。特に，<strong class='red'>赤色の加速する小弾はこのゲーム屈指の凶悪な弾幕です。</strong>また，白色の粒弾は魔方陣と重なると視認性が非常に悪くなります。これらには最大限警戒しつつ，積極的に攻撃していきましょう。"
      },
      {
        "time": 293,
        "label": "コアントロー１",
        "description": "最初の攻撃は黄色の壁が１回につき２つ飛んできますが，１つ目の壁の間で自機狙いの小弾をやり過ごしてから２つ目の壁を避けます。弾が速いですが，見た目ほどは難しくありません。なお，こちらもシューと同様に，<strong>ボスが出現した瞬間から攻撃が通ります。</strong>あらかじめしっかりと撃ち込んでおきましょう。"
      },
      {
        "time": 330,
        "label": "コアントロー２",
        "description": "右下を維持すると避けやすいです。"
      },
      {
        "time": 348,
        "label": "コアントロー３",
        "description": "<strong>準難所です。</strong>セットの終わり際の瞬間難易度がやや高いです。自機方向へ放たれる中弾が爆発した後，その場所の方向を目がけて画面上の弾が集まります。ある程度は弾が消えるものの，敵のランダムな移動と弾速によっては難しい配置を強要されることがあります。ただし，攻撃が始まってから十分に攻撃を当て続けることができれば，ばらけた赤弾が飛んでくる前に攻撃を終わらせることは可能です。しかし，実際は常にランダムな敵の移動に備えながら攻撃しければならないので，意図的に行うことは難しいです。"
      },
      {
        "time": 376,
        "label": "コアントロー４",
        "description": "<strong class='red'>難所です。</strong>一度ばらけた弾が次の中弾の爆発までに画面外へ出ていかないことがあります。このような弾は次の爆発に巻き込まれて再度戻ってきます。基本的には敵から距離をとることが望ましいですが，弾の配置によっては最下段を維持していても多くの弾が近づいてくることがあります。視野を広く確保し，予期せぬ弾の移動に備えましょう。"
      },
      {
        "time": 393,
        "label": "コアントロー５",
        "description": "<strong>準難所です。</strong>敵は常に上の方にいるものの，そこそこ密度のある速い弾幕を永遠と避け続けさせられます。撃破まで気を抜かずに避けましょう。"
      }
    ]
  }
};
      const pageConfig = data['default'];

      if (!pageConfig) return;

      const originalTitle = pageConfig.label;
      pageConfig.title = `【Normal】${pageConfig.label}`;
      pageConfig.originalTitle = originalTitle;
      pageConfig.characterKey = 'default';

      let cachedAllTimestamps = null;

      const getAllTimestamps = () => {
        if (cachedAllTimestamps !== null) {
          return cachedAllTimestamps;
        }

        let allTimestamps = Array.isArray(pageConfig.timestamps) ? pageConfig.timestamps : [];
        cachedAllTimestamps = allTimestamps.sort((a, b) => a.time - b.time);
        return cachedAllTimestamps;
      };

      const videoFrame = document.getElementById('videoFrame');
      const videoId = pageConfig.videoId;

      const h1 = document.querySelector('h1');
      if (h1) h1.textContent = pageConfig.title;

      const defaultH3 = document.querySelector('#content-default h3');
      if (defaultH3) defaultH3.textContent = pageConfig.originalTitle || pageConfig.title;

      const characterMsg = document.querySelector('#content-default #character-message');
      if (characterMsg) characterMsg.textContent = pageConfig.description || '';

      const instructionMsg = document.querySelector('#content-default #instruction-message');
      if (instructionMsg) instructionMsg.textContent = '※タイムスタンプを選択すると説明が表示されます。';

      function renderTimestamps() {
        const allTimestamps = getAllTimestamps();
        const listContainer = document.querySelector('#timestamps-list ul');
        const contentPanel = document.getElementById('content-panel');
        if (!listContainer) return;

        listContainer.innerHTML = '';

        if (allTimestamps.length === 0) {
          const li = document.createElement('li');
          li.textContent = '（タイムスタンプなし）';
          li.style.textAlign = 'center';
          li.style.opacity = '0.5';
          listContainer.appendChild(li);
          return;
        }

        allTimestamps.forEach(function (ts, index) {
          if (!ts.time || !ts.label || !ts.description) return;

          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = '#';
          a.className = 'timestamp-link';
          a.textContent = ts.label;

          a.addEventListener('click', function (e) {
            e.preventDefault();
            jumpToTimestamp(index);
          });

          li.appendChild(a);
          listContainer.appendChild(li);

          const contentId = `content-${index}`;
          if (!document.getElementById(contentId)) {
            const contentDiv = document.createElement('div');
            contentDiv.id = contentId;
            contentDiv.className = 'stamp-content hidden';
            contentDiv.innerHTML = `<h3>${ts.label}</h3><p>${ts.description || ''}</p>`;
            contentPanel.appendChild(contentDiv);
          }
        });
      }

      function jumpToTimestamp(index) {
        const allTimestamps = getAllTimestamps();
        const ts = allTimestamps[index];
        if (!ts) return;

        if (videoId && videoFrame) {
          videoFrame.src = getYouTubeEmbedUrl(videoId, ts.time);
        }

        document.querySelectorAll('.stamp-content').forEach(el => {
          el.classList.add('hidden');
        });

        const contentId = `content-${index}`;
        const selectedContent = document.getElementById(contentId);
        if (selectedContent) {
          selectedContent.classList.remove('hidden');
        }
      }

      function showDefaultContent() {
        document.querySelectorAll('.stamp-content').forEach(el => {
          el.classList.add('hidden');
        });
        const defaultContent = document.getElementById('content-default');
        if (defaultContent) defaultContent.classList.remove('hidden');
      }

      renderTimestamps();
      if (videoId && videoFrame) {
        videoFrame.src = getYouTubeEmbedUrl(videoId);
      }
      showDefaultContent();

      const SYNC_DELAY = 100;
      const syncPanelHeights = () => {
        const videoPanel = document.querySelector('.video-panel');
        const timestampsPanel = document.querySelector('.timestamps-panel');
        videoPanel && timestampsPanel && (timestampsPanel.style.height = videoPanel.getBoundingClientRect().height + 'px');
      };

      if (window.lastSyncPanelHeights) {
        ['load', 'resize'].forEach(event => window.removeEventListener(event, window.lastSyncPanelHeights));
      }
      window.lastSyncPanelHeights = syncPanelHeights;
      ['load', 'resize'].forEach(event => window.addEventListener(event, syncPanelHeights));
      setTimeout(syncPanelHeights, SYNC_DELAY);
      document.body.style.display = 'block';
    }

    const container = document.getElementById('container');
    container.innerHTML = `
      <h1></h1>
      <div class="video-container">
        <div class="video-panel">
          <div class="video-wrapper">
            <iframe id="videoFrame" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
          </div>
        </div>
        <div class="timestamps-panel">
          <div class="timestamps-list" id="timestamps-list">
            <ul></ul>
          </div>
        </div>
      </div>
      <div id="content-panel" class="content-panel">
        <div id="content-default" class="stamp-content">
          <h3></h3>
          <p id="character-message"></p>
          <p id="instruction-message"></p>
        </div>
      </div>
    `;

    const allElementsReady = Promise.all([
      document.readyState === 'complete' ? Promise.resolve() : new Promise(resolve => window.addEventListener('load', resolve)),
      new Promise(resolve => {
        if (document.getElementById('videoFrame')) resolve();
        else {
          const observer = new MutationObserver(() => {
            if (document.getElementById('videoFrame')) {
              observer.disconnect();
              resolve();
            }
          });
          observer.observe(container, { childList: true, subtree: true });
        }
      })
    ]).finally(initializeTmgc);
  </script>
</body>
</html>