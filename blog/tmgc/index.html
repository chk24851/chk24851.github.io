<!DOCTYPE html>
<html lang="ja">
<head>
  <title>トルテルマジック</title>
  <style>
    body { display: none; }
  </style>
  <link rel="stylesheet" href="../../style.css">
  <script src="../../components/loader.js"></script>
</head>
<body>
  <div class="container" id="container">
  </div>

  <script>
    async function initializeTmgc() {
      const data = {
  "stageLabels": ["道中", "ボス", "裏ボス"],
  "default": {
    "title": "トルテルマジック",
    "message": "自機の当たり判定は「スカートの裾」が目安です。道中の敵に当たり判定はありません。",
    "videoId": "mtLp4bveBmQ",
    "stageData": {
      "1": {
        "timestamps": [
          {
            "time": 2,
            "label": "道中１",
            "content": "敵の配置は一見するとランダムですが，ゲーム起動後１回目は同じになります（もしかしたら２回目以降や開幕以降も同じかもしれませんが，検証していません）。そのため，開幕の動きは固定化することができます。"
          },
          {
            "time": 89,
            "label": "道中２",
            "content": "敵がランダムに動き回りながら全方位弾を放ってきます。弾を放つタイミングもランダムで，連続で放ってくることもあります。特に厄介なのは，敵が左右の画面外の見えない場所を経由して突然左右下端に出現する可能性があることです。中央下を陣取っていてもかなり接近してくることがあるので，十分に注意する必要があります。"
          }
        ]
      },
      "2": {
        "timestamps": [
          {
            "time": 120,
            "label": "シュー１",
            "content": "<strong>準難所です。</strong>シューの動きによっては粒弾の列が乱れ，早めに抜ける必要がある配置になることがあります。常に弾へ近づいておき，いつでも抜けられるようにすると良いでしょう。また，<strong>ボスが出現した瞬間から攻撃が通ります。</strong>あらかじめしっかりと撃ち込んでおきましょう。"
          },
          {
            "time": 222,
            "label": "シュー２",
            "content": "<strong>準難所です。</strong>特に，赤色の加速する小弾は弾源の位置によっては難しい配置になります。また，攻撃の種類が変化する間がありません。どんな種類に変わっても対処できるように常に構えておきましょう。"
          },
          {
            "time": 251,
            "label": "シュー３",
            "content": "<strong class='red'>難所です。</strong>弾源の位置が敵の移動に合わせて相対的に変化するだけでなく，１つ前の攻撃と比べて難しい弾幕を飛ばしてきます。特に，<strong class='red'>赤色の加速する小弾はこのゲーム屈指の凶悪な弾幕です。</strong>また，白色の粒弾は魔方陣と重なると視認性が非常に悪くなります。これらには最大限警戒しつつ，積極的に攻撃していきましょう。"
          }
        ]
      },
      "3": {
        "timestamps": [
          {
            "time": 293,
            "label": "コアントロー１",
            "content": "最初の攻撃は黄色の壁が１回につき２つ飛んできますが，１つ目の壁の間で自機狙いの小弾をやり過ごしてから２つ目の壁を避けます。弾が速いですが，見た目ほどは難しくありません。なお，こちらもシューと同様に，<strong>ボスが出現した瞬間から攻撃が通ります。</strong>あらかじめしっかりと撃ち込んでおきましょう。"
          },
          {
            "time": 330,
            "label": "コアントロー２",
            "content": "右下を維持すると避けやすいです。"
          },
          {
            "time": 348,
            "label": "コアントロー３",
            "content": "<strong>準難所です。</strong>セットの終わり際の瞬間難易度がやや高いです。自機方向へ放たれる中弾が爆発した後，その場所の方向を目がけて画面上の弾が集まります。ある程度は弾が消えるものの，敵の位置は毎回異なるし弾は速いため，難しい配置を強要されることもあります。中弾を誘導することでばらけた赤弾の処理を楽にできたら良いですが，中弾を飛ばす直前に敵がランダムに移動するため，それは難しいでしょう。ただし，攻撃が始まってからかなりしっかりと攻撃を当て続けることができれば，ばらけた赤弾が飛んでくる前に攻撃を終わらせることは可能です（が，常にランダムな敵の移動に備えなければならないので，意図的に行うことは難しいと思います。基本的には，攻撃中に敵が近づいてきたなどということがあった結果，偶発的に起こるものです）。"
          },
          {
            "time": 376,
            "label": "コアントロー４",
            "content": "<strong class='red'>難所です。</strong>一度ばらけた弾が次の中弾の爆発までに画面外へたどり着かないゆえに，爆発に巻き込まれて再度戻ってくることがあります。基本的には敵から距離をとることが望ましいですが，弾の配置によっては最下段を維持していても多くの弾が近づいてくることがあります。視野を広く確保し，予期せぬ弾の移動に備えましょう。"
          },
          {
            "time": 393,
            "label": "コアントロー５",
            "content": "<strong>準難所です。</strong>敵は常に上の方にいるものの，そこそこ密度のある速い弾幕を永遠と避け続けさせられます。撃破まで気を抜かずに避けましょう。"
          }
        ]
      }
    }
  }
};
      const pageConfig = data['default'];

      if (!pageConfig) return;

      const originalTitle = pageConfig.title;
      pageConfig.title = `【Normal】${pageConfig.title}`;
      pageConfig.originalTitle = originalTitle;
      pageConfig.stageLabels = data.stageLabels;
      
      const stageData = pageConfig.stageData || {};
      const videoFrame = document.getElementById('videoFrame');
      const videoId = pageConfig.videoId;
      const stageLabels = pageConfig.stageLabels || [];
      let currentStage = 1;

      const h1 = document.querySelector('h1');
      if (h1) h1.textContent = pageConfig.title;

      const defaultH3 = document.querySelector('#content-default h3');
      if (defaultH3) defaultH3.textContent = pageConfig.originalTitle || pageConfig.title;

      const characterMsg = document.querySelector('#content-default #character-message');
      if (characterMsg) characterMsg.textContent = pageConfig.message || '';

      const instructionMsg = document.querySelector('#content-default #instruction-message');
      if (instructionMsg) instructionMsg.textContent = '※タイムスタンプを選択すると説明が表示されます。';

      const dropdown = document.getElementById('stage-dropdown');
      if (dropdown) {
        stageLabels.forEach(function (label, index) {
          const option = document.createElement('option');
          option.value = index + 1;
          option.textContent = label;
          dropdown.appendChild(option);
        });

        dropdown.addEventListener('change', function (e) {
          currentStage = parseInt(e.target.value);
          renderTimestamps(currentStage);
          showDefaultContent();
        });
      }

      const prevBtn = document.getElementById('prev-stage');
      const nextBtn = document.getElementById('next-stage');

      if (prevBtn) {
        prevBtn.addEventListener('click', function () {
          currentStage = Math.max(1, currentStage - 1);
          if (dropdown) dropdown.value = currentStage;
          renderTimestamps(currentStage);
          showDefaultContent();
        });
      }

      if (nextBtn) {
        nextBtn.addEventListener('click', function () {
          const maxStage = Object.keys(stageData).length;
          currentStage = Math.min(maxStage, currentStage + 1);
          if (dropdown) dropdown.value = currentStage;
          renderTimestamps(currentStage);
          showDefaultContent();
        });
      }

      function renderTimestamps(stage) {
        const timestamps = stageData[stage] ? stageData[stage].timestamps : [];
        const listContainer = document.querySelector('#timestamps-list ul');
        const contentPanel = document.getElementById('content-panel');
        if (!listContainer) return;

        listContainer.innerHTML = '';

        timestamps.forEach(function (ts, index) {
          if (!ts.label || ts.label.trim() === '') {
            return;
          }

          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = '#';
          a.className = 'timestamp-link';
          a.textContent = ts.label;

          a.addEventListener('click', function (e) {
            e.preventDefault();
            jumpToTimestamp(stage, index);
          });

          li.appendChild(a);
          listContainer.appendChild(li);

          const contentId = 'content-' + stage + '-' + index;
          if (!document.getElementById(contentId)) {
            const contentDiv = document.createElement('div');
            contentDiv.id = contentId;
            contentDiv.className = 'stamp-content hidden';
            contentDiv.innerHTML = `<h3>${ts.label}</h3><p>${ts.content || ''}</p>`;
            contentPanel.appendChild(contentDiv);
          }
        });
      }

      function jumpToTimestamp(stage, index) {
        const ts = stageData[stage] ? stageData[stage].timestamps[index] : null;
        if (!ts) return;

        if (videoId && videoFrame) {
          videoFrame.src = 'https://www.youtube.com/embed/' + videoId + '?start=' + ts.time + '&autoplay=1';
        }

        document.querySelectorAll('.stamp-content').forEach(function (el) {
          el.classList.add('hidden');
        });

        const contentId = 'content-' + stage + '-' + index;
        const selectedContent = document.getElementById(contentId);
        if (selectedContent) {
          selectedContent.classList.remove('hidden');
        }
      }

      function showDefaultContent() {
        document.querySelectorAll('.stamp-content').forEach(function (el) {
          el.classList.add('hidden');
        });
        const defaultContent = document.getElementById('content-default');
        if (defaultContent) defaultContent.classList.remove('hidden');
      }

      renderTimestamps(1);
      if (videoId && videoFrame) {
        videoFrame.src = 'https://www.youtube.com/embed/' + videoId + '?autoplay=1';
      }
      showDefaultContent();

      // Synchronize video panel and timestamps panel heights
      const SYNC_DELAY = 100; // ms
      const syncPanelHeights = () => {
        const videoPanel = document.querySelector('.video-panel');
        const timestampsPanel = document.querySelector('.timestamps-panel');
        videoPanel && timestampsPanel && (timestampsPanel.style.height = videoPanel.getBoundingClientRect().height + 'px');
      };

      ['load', 'resize'].forEach(event => window.addEventListener(event, syncPanelHeights));
      setTimeout(syncPanelHeights, SYNC_DELAY);
    }

    const container = document.getElementById('container');
    container.innerHTML = `
      <h1></h1>
      <div class="video-container">
        <div class="video-panel">
          <div class="video-wrapper">
            <iframe id="videoFrame" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
          </div>
        </div>
        <div class="timestamps-panel">
          <div class="stage-selector">
            <button class="stage-arrow" id="prev-stage">←</button>
            <select id="stage-dropdown"></select>
            <button class="stage-arrow" id="next-stage">→</button>
          </div>
          <div class="timestamps-list" id="timestamps-list">
            <ul></ul>
          </div>
        </div>
      </div>
      <div id="content-panel" class="content-panel">
        <div id="content-default" class="stamp-content">
          <h3></h3>
          <p id="character-message"></p>
          <p id="instruction-message"></p>
        </div>
      </div>
    `;

    const allElementsReady = Promise.all([
      document.readyState === 'complete' ? Promise.resolve() : new Promise(resolve => window.addEventListener('load', resolve)),
      new Promise(resolve => {
        if (document.getElementById('videoFrame')) resolve();
        else {
          const observer = new MutationObserver(() => {
            if (document.getElementById('videoFrame')) {
              observer.disconnect();
              resolve();
            }
          });
          observer.observe(container, { childList: true, subtree: true });
        }
      })
    ]).finally(initializeTmgc);
  </script>
</body>
</html>
